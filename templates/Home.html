{% extends "BaseWithNav.html" %}

{% block title %}
<title>Employee Timesheet - Home</title>

{% endblock %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
{% endblock %}

<!--Navbar-->
{% block body %}

<div style="height:8vh">

</div>
<!-- Dashboard -->
<main class="dashboard">
  <div style="display: flex; justify-content: space-between; align-items: center;">
  <div style="display: flex; gap: 10px; align-items: center;">
    <select id="searchColumn" class="search-dropdown">
      <option value="">-- Search by Column --</option>
      <option value="Project_Name">Project Name</option>
      <option value="Task">Task</option>
      <option value="activity">Activity</option>
      <option value="Tdate">Date</option>
      <option value="description">Description</option>
    </select>
    <input type="text" id="searchInput" class="search-bar" placeholder="Search tasks..." />
    <button id="searchBtn" class="search">Search</button>
    <button id="clearBtn" class="search" style="background-color: #6c757d;">Clear</button>
  </div>
  <!-- Add Task Button -->
  <div class="add-task-container">
    <button type="button" id="addTaskBtn" class="add-task-btn">+ Add Task</button>
  </div>
  </div>
<!-- Task Form (popup) -->
<div class="task-form-container" id="taskFormPopup">
  <form method="POST" action="/add_task" class="task-form">

    <h2 class="form-title">Add Task</h2>

    <div class="form-group">
      <label for="date">Select Date:</label>
      <input type="date" id="date" name="date" required />
    </div>

    <div class="form-group">
      <label for="projectDropdown">Select Project:</label>
      <select id="projectDropdown" name="project_id" required>
        <option value="">-- Select Project --</option>
      </select>
    </div>

    <div class="form-group">
      <label for="taskDropdown">Select Task:</label>
      <select id="taskDropdown" name="task_id" required>
        <option value="">-- Select Task --</option>
      </select>
    </div>

    <div class="form-group">
      <label for="activity">Select Activity:</label>
      <input type="text" id="activity" name="activity" required />
    </div>

    <div class="form-group">
      <label for="hours">Actual Hours:</label>
      <input type="number" id="hours" name="hours" step="0.5" min="0" max="8" required />
    </div>

    <div class="form-group">
      <label for="overtime">Overtime:</label>
      <input type="number" id="overtime" name="overtime" step="0.5" min="0" max="8" />
    </div>

    <div class="form-group">
      <label for="description">Description:</label>
      <textarea id="description" name="description" rows="4" required></textarea>
    </div>

    <div class="form-actions">
      <button type="submit" class="add-task-btn">Submit</button>
      <button type="button" id="closeFormBtn" class="close-btn">Close</button>
    </div>
  </form>
</div>

  <!-- Task Table -->
  <section class="task-section">
    <h2>Your Logged Tasks</h2>
    <table class="task-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Project Name</th>
          <th>Task Name</th>
          <th>Activity</th>
          <th>Actual Work Hours</th>
          <th>Overtime</th>
          <th>Description</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="taskTableBody">
        {% if entries %}
        {% for entry in data %}
        <tr id={{ entry.id }}>
          <td>{{ entry.Tdate }}</td>
          <td>{{ entry.Project_Name }}</td>
          <td>{{ entry.Task }}</td>
          <td>{{ entry.activity }}</td>
          <td>{{ entry.hours }}</td>
          <td>{{ entry.overtime }}</td>
          <td>{{ entry.description }}</td>
          <td>

            <form action="/update_task/{{ entry.id }}" method="POST">
              <button type="submit" class="update-btn">Update</button>
            </form>

            <form action="/delete_task/{{ entry.id }}" method="POST">
              <button type="submit" class="delete-btn">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="7">No tasks logged yet</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </section>
</main>

<!-- Footer -->
<footer class="footer" style="padding: 1px; text-align: center; color: #aeaeae;">
  <p>&copy; 2025 Employee Timesheet Project</p>
</footer>

<!-- JS -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const addBtn = document.getElementById('addTaskBtn');
    const formContainer = document.querySelector('.task-form-container');
    const closeBtn = document.getElementById('closeFormBtn');
    const projectDropdown = document.getElementById('projectDropdown');
    const taskDropdown = document.getElementById('taskDropdown');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const searchInput = document.getElementById('searchInput');
    const searchColumn = document.getElementById('searchColumn');
    const taskTableBody = document.getElementById('taskTableBody');

    // Toggle popup
    addBtn.addEventListener('click', () => formContainer.classList.toggle('show'));
    closeBtn.addEventListener('click', () => formContainer.classList.remove('show'));

    // Fetch projects
    fetch('/getProjects')
      .then(res => res.json())
      .then(data => {
        projectDropdown.innerHTML = '<option value="">-- Select Project --</option>';
        (data.projects || []).forEach(proj => {
          const option = document.createElement('option');
          option.value = proj.id;
          option.textContent = proj.name;
          projectDropdown.appendChild(option);
        });
      })
      .catch(() => {
        projectDropdown.innerHTML = '<option value="">Failed to load</option>';
      });

    // Fetch tasks when project changes
    projectDropdown.addEventListener('change', function () {
      const projectId = this.value;
      taskDropdown.innerHTML = '<option value="">-- Select Task --</option>';
      if (projectId) {
        fetch(`/getTasks/${projectId}`)
          .then(res => res.json())
          .then(data => {
            (data.tasks || []).forEach(task => {
              const option = document.createElement('option');
              option.value = task.id;
              option.textContent = task.task;
              taskDropdown.appendChild(option);
            });
          })
          .catch(() => {
            taskDropdown.innerHTML = '<option value="">Failed to load</option>';
          });
      }
    });

    // Search functionality
    searchBtn.addEventListener('click', function () {
      const searchValue = searchInput.value.trim();
      const columnName = searchColumn.value;

      if (!columnName) {
        alert('Please select a column to search in');
        return;
      }

      if (!searchValue) {
        alert('Please enter a search term');
        return;
      }

      fetch('/search_tasks', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          search_term: searchValue,
          column: columnName
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Clear existing rows
            taskTableBody.innerHTML = '';
            
            if (data.results.length === 0) {
              const row = document.createElement('tr');
              row.innerHTML = '<td colspan="8">No tasks found matching your search</td>';
              taskTableBody.appendChild(row);
            } else {
              // Populate with search results
              data.results.forEach(entry => {
                const row = document.createElement('tr');
                row.id = entry.id;
                row.innerHTML = `
                  <td>${entry.Tdate}</td>
                  <td>${entry.Project_Name}</td>
                  <td>${entry.Task}</td>
                  <td>${entry.activity}</td>
                  <td>${entry.hours}</td>
                  <td>${entry.overtime || ''}</td>
                  <td>${entry.description}</td>
                  <td>
                    <form action="/update_task/${entry.id}" method="POST" style="display:inline;">
                      <button type="submit" class="update-btn">Update</button>
                    </form>
                    <form action="/delete_task/${entry.id}" method="POST" style="display:inline;">
                      <button type="submit" class="delete-btn">Delete</button>
                    </form>
                  </td>
                `;
                taskTableBody.appendChild(row);
              });
            }
          }
        })
        .catch(err => {
          alert('Search failed: ' + err);
          console.error('Search error:', err);
        });
    });

    // Clear search and reload all tasks
    clearBtn.addEventListener('click', function () {
      searchInput.value = '';
      searchColumn.value = '';
      location.reload();
    });

    // Allow Enter key in search input to trigger search
    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        searchBtn.click();
      }
    });
  });
</script>

{% endblock %}